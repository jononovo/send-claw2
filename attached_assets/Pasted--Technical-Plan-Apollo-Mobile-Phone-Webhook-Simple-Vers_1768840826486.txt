# Technical Plan: Apollo Mobile Phone Webhook (Simple Version)

## Overview

Apollo returns mobile/personal phone numbers asynchronously via webhook. When we request `reveal_phone_number=true` with a `webhook_url`, Apollo processes the request and delivers phone data **5-15 minutes later**.

**Important UX Note:** This is NOT instant. Users will see "Finding phone..." and need to wait or come back later.

---

## What We're Building

1. Add 2 fields to contacts table
2. Create 1 webhook endpoint  
3. Modify Apollo API call to include webhook URL
4. Update UI to show phone status

That's it. No separate tables, no background jobs, no complex verification.

---

## 1. Database Schema Changes

**File:** `shared/schema.ts`

Add these 2 fields to the `contacts` table:

```typescript
// Add to contacts table definition
mobilePhoneStatus: text("mobile_phone_status"), // 'pending' | 'found' | 'not_found' | null
mobilePhoneRequestedAt: timestamp("mobile_phone_requested_at"),
```

**Migration:** Run drizzle-kit to generate and apply migration.

---

## 2. Environment Variables

**Add to `.env`:**

```
APOLLO_PHONE_WEBHOOK_TOKEN=generate-a-random-32-char-string
APP_BASE_URL=https://5ducks.ai
```

The webhook URL will be: `${APP_BASE_URL}/api/webhooks/apollo/phone?token=${APOLLO_PHONE_WEBHOOK_TOKEN}`

---

## 3. Webhook Endpoint

**Create file:** `server/webhooks/apollo-phone-webhook.ts`

```typescript
import { Request, Response } from "express";
import { storage } from "../storage";

/**
 * POST /api/webhooks/apollo/phone?token=xxx
 * 
 * Receives phone data from Apollo after they process our reveal_phone_number request.
 * Apollo sends this 5-15 minutes after we make the initial API call.
 */
export async function handleApolloPhoneWebhook(req: Request, res: Response) {
  try {
    // 1. Verify token
    const token = req.query.token;
    if (token !== process.env.APOLLO_PHONE_WEBHOOK_TOKEN) {
      console.error('[Apollo Webhook] Invalid token');
      return res.status(401).json({ error: 'Invalid token' });
    }

    // 2. Extract data from Apollo's payload
    const payload = req.body;
    console.log('[Apollo Webhook] Received payload:', JSON.stringify(payload, null, 2));

    // Apollo sends person data with phone numbers
    const person = payload.person;
    if (!person) {
      console.error('[Apollo Webhook] No person in payload');
      return res.status(400).json({ error: 'No person data' });
    }

    const apolloPersonId = person.id;
    const phones = person.phone_numbers || person.phones || [];
    
    // Find mobile phone (prefer mobile, fall back to any)
    const mobilePhone = phones.find((p: any) => 
      p.type === 'mobile' || p.type === 'cell' || p.type === 'personal'
    ) || phones[0];

    // 3. Find the contact by Apollo person ID
    // We stored this when we made the original request
    const contact = await storage.findContactByApolloPersonId(apolloPersonId);
    
    if (!contact) {
      console.error('[Apollo Webhook] No contact found for Apollo ID:', apolloPersonId);
      // Still return 200 so Apollo doesn't retry
      return res.status(200).json({ message: 'Contact not found, acknowledged' });
    }

    // 4. Update the contact
    if (mobilePhone && mobilePhone.number) {
      await storage.updateContact(contact.id, {
        phoneNumber: mobilePhone.number || mobilePhone.sanitized_number,
        mobilePhoneStatus: 'found',
      });
      console.log(`[Apollo Webhook] Updated contact ${contact.id} with phone: ${mobilePhone.number}`);
    } else {
      await storage.updateContact(contact.id, {
        mobilePhoneStatus: 'not_found',
      });
      console.log(`[Apollo Webhook] No phone found for contact ${contact.id}`);
    }

    // 5. Return 200 so Apollo knows we received it
    return res.status(200).json({ success: true });

  } catch (error) {
    console.error('[Apollo Webhook] Error:', error);
    // Return 200 anyway to prevent Apollo from retrying endlessly
    return res.status(200).json({ error: 'Internal error, acknowledged' });
  }
}
```

---

## 4. Register the Webhook Route

**File:** `server/routes.ts`

Add:

```typescript
import { handleApolloPhoneWebhook } from "./webhooks/apollo-phone-webhook";

// In the route setup section:
app.post("/api/webhooks/apollo/phone", handleApolloPhoneWebhook);
```

---

## 5. Storage Method

**File:** `server/storage.ts`

Add method to find contact by Apollo person ID:

```typescript
async findContactByApolloPersonId(apolloPersonId: string): Promise<Contact | null> {
  const [contact] = await db
    .select()
    .from(contacts)
    .where(eq(contacts.apolloPersonId, apolloPersonId))
    .limit(1);
  return contact || null;
}
```

**Note:** We also need to store `apolloPersonId` on the contact. Add this field:

```typescript
// In shared/schema.ts contacts table
apolloPersonId: text("apollo_person_id"),
```

---

## 6. Modify Apollo API Call

**File:** `server/search/providers/apollo.ts`

When making the People Enrichment call, add webhook parameters:

```typescript
export async function searchApolloDirect(contact: any, company: any, apiKey: string, options?: { revealPhone?: boolean }): Promise<any> {
  const webhookUrl = options?.revealPhone 
    ? `${process.env.APP_BASE_URL}/api/webhooks/apollo/phone?token=${process.env.APOLLO_PHONE_WEBHOOK_TOKEN}`
    : undefined;

  const response = await axios.post('https://api.apollo.io/v1/people/match', {
    first_name: contact.name.split(' ')[0],
    last_name: contact.name.split(' ').slice(1).join(' '),
    organization_name: company.name,
    domain: company.website,
    reveal_phone_number: options?.revealPhone || false,
    webhook_url: webhookUrl,
  }, {
    headers: {
      'x-api-key': apiKey,
      'Content-Type': 'application/json',
    },
    timeout: 20000,
  });

  // Store Apollo's person ID so webhook can find this contact later
  const apolloPersonId = response.data?.person?.id;
  
  return {
    success: true,
    contact: {
      ...contact,
      email: response.data?.person?.email,
      apolloPersonId: apolloPersonId, // IMPORTANT: Save this!
    },
    // Employer phone comes back immediately
    employerPhone: response.data?.person?.organization?.phone,
  };
}
```

---

## 7. Create "Find Mobile Phone" Endpoint

**File:** `server/features/search-phone/routes.ts` (new file)

```typescript
import { Request, Response } from "express";
import { storage } from "../../storage";
import { searchApolloDirect } from "../../search/providers/apollo";
import { CreditService } from "../credits/credit-service";

const MOBILE_PHONE_CREDIT_COST = 8;

export async function findMobilePhone(req: Request, res: Response) {
  try {
    const contactId = parseInt(req.params.contactId);
    const userId = req.user?.id; // however you get user ID

    // 1. Get contact
    const contact = await storage.getContact(contactId, userId);
    if (!contact) {
      return res.status(404).json({ error: 'Contact not found' });
    }

    // 2. Check if already pending or found
    if (contact.mobilePhoneStatus === 'pending') {
      return res.status(400).json({ error: 'Phone lookup already in progress' });
    }
    if (contact.mobilePhoneStatus === 'found' && contact.phoneNumber) {
      return res.json({ contact, message: 'Phone already found' });
    }

    // 3. Check credits
    const hasCredits = await CreditService.checkCredits(userId, MOBILE_PHONE_CREDIT_COST);
    if (!hasCredits) {
      return res.status(402).json({ error: 'Insufficient credits', required: MOBILE_PHONE_CREDIT_COST });
    }

    // 4. Get company
    const company = await storage.getCompany(contact.companyId, userId);
    if (!company) {
      return res.status(404).json({ error: 'Company not found' });
    }

    // 5. Mark as pending BEFORE making API call
    await storage.updateContact(contactId, {
      mobilePhoneStatus: 'pending',
      mobilePhoneRequestedAt: new Date(),
    });

    // 6. Call Apollo with webhook
    const apolloApiKey = process.env.APOLLO_API_KEY;
    const result = await searchApolloDirect(contact, company, apolloApiKey, { revealPhone: true });

    // 7. Save Apollo person ID for webhook correlation
    if (result.contact.apolloPersonId) {
      await storage.updateContact(contactId, {
        apolloPersonId: result.contact.apolloPersonId,
      });
    }

    // 8. Deduct credits
    await CreditService.deductCredits(userId, MOBILE_PHONE_CREDIT_COST);

    // 9. Return - phone will arrive via webhook in 5-15 minutes
    const updatedContact = await storage.getContact(contactId, userId);
    return res.json({
      contact: updatedContact,
      message: 'Phone lookup initiated. Results will arrive in 5-15 minutes.',
    });

  } catch (error) {
    console.error('[FindMobilePhone] Error:', error);
    return res.status(500).json({ error: 'Failed to initiate phone lookup' });
  }
}
```

**Register route in `server/routes.ts`:**

```typescript
import { findMobilePhone } from "./features/search-phone/routes";

app.post("/api/contacts/:contactId/find-mobile-phone", findMobilePhone);
```

---

## 8. UI Updates

**File:** `client/src/components/contact-row.tsx`

Add a "Find Mobile" button and status indicator:

```tsx
// Phone status display
{contact.mobilePhoneStatus === 'pending' && (
  <span className="text-yellow-500 text-sm flex items-center gap-1">
    <Loader2 className="h-3 w-3 animate-spin" />
    Finding phone...
  </span>
)}

{contact.mobilePhoneStatus === 'found' && contact.phoneNumber && (
  <span className="text-green-500">{contact.phoneNumber}</span>
)}

{contact.mobilePhoneStatus === 'not_found' && (
  <span className="text-gray-400 text-sm">No mobile found</span>
)}

{/* Button to trigger phone lookup */}
{!contact.mobilePhoneStatus && !contact.phoneNumber && (
  <Button 
    size="sm" 
    variant="ghost"
    onClick={() => findMobilePhone(contact.id)}
  >
    <Phone className="h-4 w-4 mr-1" />
    Find Mobile
  </Button>
)}
```

---

## 9. Summary of Changes

| File | Change |
|------|--------|
| `shared/schema.ts` | Add 3 fields: `mobilePhoneStatus`, `mobilePhoneRequestedAt`, `apolloPersonId` |
| `server/storage.ts` | Add `findContactByApolloPersonId()` method |
| `server/webhooks/apollo-phone-webhook.ts` | **NEW** - Webhook handler |
| `server/features/search-phone/routes.ts` | **NEW** - Find mobile phone endpoint |
| `server/routes.ts` | Register 2 new routes |
| `server/search/providers/apollo.ts` | Add `revealPhone` option with webhook URL |
| `client/src/components/contact-row.tsx` | Add phone status UI and button |
| `.env` | Add `APOLLO_PHONE_WEBHOOK_TOKEN`, `APP_BASE_URL` |

---

## 10. Testing

1. **Manual test:** Click "Find Mobile" on a contact, verify:
   - Contact shows "Finding phone..." immediately
   - Credits are deducted
   - 5-15 minutes later, webhook receives data
   - Contact updates with phone number

2. **Webhook test:** Use a tool like webhook.site to inspect Apollo's payload format, then adjust parsing if needed.

3. **Edge cases:**
   - What if Apollo never sends webhook? Contact stays "pending" forever. Acceptable for MVP.
   - What if user clicks button twice? We check `mobilePhoneStatus === 'pending'` and reject.

---

## What We're NOT Building (Intentionally)

- ❌ Separate tracking table
- ❌ Background jobs for timeouts
- ❌ HMAC signature verification
- ❌ IP allowlisting
- ❌ Credit refunds
- ❌ Retry logic

These can be added later if needed. Start simple.
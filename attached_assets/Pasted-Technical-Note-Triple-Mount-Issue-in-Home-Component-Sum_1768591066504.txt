Technical Note: Triple Mount Issue in Home Component
Summary
The Home component on /app is mounting 3 times on every page load, causing duplicate API calls and unnecessary re-renders. This is a significant performance issue that should be fixed.
Evidence
Console logs from a fresh page load of https://5ducks.ai/app:
[2:13:48 PM] ðŸŸ£ COMPONENT MOUNT - Home page mounting
[2:13:48 PM] Firebase auth state changed: jon@codetribe.com
[2:13:48 PM] ðŸŸ£ COMPONENT MOUNT - Home page mounting      â† 2nd mount
[2:13:48 PM] Firebase auth state changed: jon@codetribe.com
[2:13:48 PM] Making backend sync request Object
[2:13:49 PM] Successfully synced with backend
[2:13:49 PM] ðŸŸ£ COMPONENT MOUNT - Home page mounting      â† 3rd mount
[2:13:49 PM] Firebase auth state changed: jon@codetribe.com
[2:13:49 PM] Making backend sync request Object
[2:13:49 PM] Successfully synced with backend
Root Cause
The issue is in client/src/hooks/use-auth.tsx. The onAuthStateChanged listener fires multiple times, and each time it calls syncWithBackend, which updates the React Query cache via queryClient.setQueryData(["/api/user"], user). This triggers components dependent on the user state to remount.
The problematic flow:

Home mounts initially (user state is null or loading)
Firebase onAuthStateChanged fires â†’ calls syncWithBackend â†’ updates ["/api/user"] in React Query â†’ user state changes â†’ Home remounts
Firebase fires onAuthStateChanged again (possibly due to getIdToken(true) forcing a token refresh) â†’ same cascade â†’ Home remounts a third time

Key code in use-auth.tsx:
typescriptunsubscribe = onAuthStateChanged(fb.auth, async (firebaseUser) => {
  console.log('Firebase auth state changed:', firebaseUser?.email);

  if (firebaseUser?.email) {
    try {
      const token = await firebaseUser.getIdToken(true);  // This may trigger another auth state change
      setAuthToken(token);
      
      // ... axios setup ...
      
      await syncWithBackend(firebaseUser);  // This updates queryClient, causing remounts
    } catch (error) {
      // ...
    }
  }
  // ...
});
And in syncWithBackend:
typescriptconst user = await safeJsonParse(createRes);
queryClient.setQueryData(["/api/user"], user);  // This triggers dependent components to re-render
Impact

3x component mounts on every /app page load
2x duplicate syncWithBackend calls (duplicate /api/google-auth API requests)
Wasted CPU cycles â€” all useEffects run 3 times
Slower Time to Interactive â€” component isn't stable until third mount

Proposed Solution
Add a guard in use-auth.tsx to prevent duplicate syncs when the user is already in the React Query cache.
Option A: Check if user already exists in cache before syncing
typescript// In the onAuthStateChanged callback
unsubscribe = onAuthStateChanged(fb.auth, async (firebaseUser) => {
  console.log('Firebase auth state changed:', firebaseUser?.email);

  if (firebaseUser?.email) {
    try {
      const token = await firebaseUser.getIdToken(true);
      setAuthToken(token);
      
      const axios = (await import('axios')).default;
      axios.defaults.headers.common['Authorization'] = `Bearer ${token}`;
      
      // Only sync if user is not already in cache
      const existingUser = queryClient.getQueryData(["/api/user"]);
      if (!existingUser) {
        await syncWithBackend(firebaseUser);
      }
    } catch (error) {
      console.error('Error during auth state sync:', error);
      queryClient.setQueryData(["/api/user"], null);
    }
  } else {
    // ... handle logout case ...
  }
  
  setAuthReady(true);
});
Option B: Use a ref to track if sync has already happened this session
typescript// Add ref at the top of AuthProvider
const hasSyncedRef = useRef(false);

// In the onAuthStateChanged callback
unsubscribe = onAuthStateChanged(fb.auth, async (firebaseUser) => {
  console.log('Firebase auth state changed:', firebaseUser?.email);

  if (firebaseUser?.email) {
    try {
      const token = await firebaseUser.getIdToken(true);
      setAuthToken(token);
      
      const axios = (await import('axios')).default;
      axios.defaults.headers.common['Authorization'] = `Bearer ${token}`;
      
      // Only sync once per session
      if (!hasSyncedRef.current) {
        hasSyncedRef.current = true;
        await syncWithBackend(firebaseUser);
      }
    } catch (error) {
      console.error('Error during auth state sync:', error);
      queryClient.setQueryData(["/api/user"], null);
    }
  } else {
    // Reset on logout so next login will sync
    hasSyncedRef.current = false;
    // ... handle logout case ...
  }
  
  setAuthReady(true);
});
Recommendation
Use Option A (check existing cache) because:

It's stateless and doesn't require tracking refs
It naturally handles edge cases like page refresh (cache is empty, so sync happens)
It's more defensive â€” if the cache somehow gets cleared, sync will happen again

Verification Steps
After implementing the fix:

Clear browser cache and hard refresh https://5ducks.ai/app
Open DevTools Console
Filter for "COMPONENT MOUNT"
Expect to see only 1 mount instead of 3
Filter for "Making backend sync request"
Expect to see only 1 sync request instead of 2

Files to Modify

client/src/hooks/use-auth.tsx â€” Add cache check before calling syncWithBackend

Technical Implementation Plan: Server Stability Improvements
Executive Summary
This plan addresses three improvements to reduce 500 errors and improve server stability:

Global error handlers with proper exit behavior (safety net for crashes)
Reduced domain logging (log once, not per-request)
Reduced auth failure logging (only log actual errors, not expected behavior)

All changes are additive and non-breaking. They improve logging hygiene and add crash protection without modifying any business logic.

Pre-Implementation Checklist
Before implementing, verify:

 Server starts successfully in current state
 Health check endpoint (/api/health) returns 200
 Authentication flow works (login/logout)
 Background jobs are running (CampaignScheduler, EmailQueueProcessor, etc.)


Change 1: Global Error Handlers
File: server/index.ts
Location: Immediately after dotenv.config() (near top of file, before Express app creation)
What to Add:
typescript// =============================================================================
// GLOBAL ERROR HANDLERS - Safety net for unhandled errors
// These MUST exit the process - continuing after unhandled errors is dangerous
// The process manager (Replit/PM2/systemd) will restart the server automatically
// =============================================================================

process.on('uncaughtException', (error: Error) => {
  console.error('=== UNCAUGHT EXCEPTION ===');
  console.error('Timestamp:', new Date().toISOString());
  console.error('Error:', error.message);
  console.error('Stack:', error.stack);
  console.error('==========================');
  
  // Give logs time to flush, then exit
  // Exit code 1 signals abnormal termination to process manager
  setTimeout(() => {
    process.exit(1);
  }, 1000);
});

process.on('unhandledRejection', (reason: unknown, promise: Promise<unknown>) => {
  console.error('=== UNHANDLED PROMISE REJECTION ===');
  console.error('Timestamp:', new Date().toISOString());
  console.error('Promise:', promise);
  console.error('Reason:', reason);
  if (reason instanceof Error) {
    console.error('Stack:', reason.stack);
  }
  console.error('===================================');
  
  // Give logs time to flush, then exit
  // Exit code 1 signals abnormal termination to process manager
  setTimeout(() => {
    process.exit(1);
  }, 1000);
});
Why This Is Safe:

Placed at top of file - Catches errors from ALL modules including imports
Always exits - Per Node.js best practices, never continues after unhandled errors
Logs before exit - Captures error details for debugging
1-second delay - Allows logs to flush before termination
Non-zero exit code - Signals to process manager that restart is needed
No business logic changes - Pure additive, observability-only change

Why This Solves Problems:

Currently, unhandled rejections in background jobs (EmailQueueProcessor, CampaignScheduler) may leave the server in a corrupted state
With these handlers, the server will cleanly restart instead of running in a broken state
The logs will show exactly what caused the crash


Change 2: Reduced Domain Logging
File: server/index.ts
Location: Find the domain capture middleware (around line 100-110)
Current Code (to replace):
typescriptapp.use((req, res, next) => {
  const protocol = req.secure || req.get('x-forwarded-proto') === 'https' ? 'https' : 'http';
  const host = req.get('host');
  if (host) {
    process.env.CURRENT_DOMAIN = `${protocol}://${host}`;
    console.log(`Current domain captured: ${process.env.CURRENT_DOMAIN}`);
  }
  next();
});
New Code:
typescript// Track if domain has been logged to avoid log spam
let domainLogged = false;

app.use((req, res, next) => {
  const protocol = req.secure || req.get('x-forwarded-proto') === 'https' ? 'https' : 'http';
  const host = req.get('host');
  if (host) {
    const newDomain = `${protocol}://${host}`;
    // Only update and log if domain actually changed
    if (process.env.CURRENT_DOMAIN !== newDomain) {
      process.env.CURRENT_DOMAIN = newDomain;
      // Only log once per server lifecycle (or when domain changes)
      if (!domainLogged) {
        console.log(`Domain captured: ${process.env.CURRENT_DOMAIN}`);
        domainLogged = true;
      }
    }
  }
  next();
});
Why This Is Safe:

Same functionality - Still captures domain correctly for all requests
Only changes logging - Business logic unchanged
Logs on change - If domain changes (rare), it will log again
Reduces log volume by ~99% - One log instead of thousands per hour

Why This Solves Problems:

Your logs show this message appearing every request, making it hard to find actual errors
Reduces log storage costs and makes debugging easier


Change 3: Reduced Auth Failure Logging
File: server/auth.ts
Location: Find the verifyFirebaseToken function, specifically the early return block
Current Code (to replace):
typescriptif (!token || !admin.apps.length) {
  console.warn('Auth verification failed:', {
    reason: !token ? 'missing credentials' : 'firebase admin not initialized',
  });
  return null;
}
New Code:
typescriptif (!token || !admin.apps.length) {
  // Only log actual error conditions, not expected "no auth" cases
  // Missing token is EXPECTED for public routes - no need to log
  // Firebase not initialized IS an error condition worth logging
  if (token && !admin.apps.length) {
    console.error('Auth verification failed: Firebase Admin not initialized but token was provided', {
      timestamp: new Date().toISOString()
    });
  }
  // Note: NOT logging when token is missing - this is expected for public pages
  return null;
}
Why This Is Safe:

Same return behavior - Still returns null in same conditions
Only changes logging - Authentication logic unchanged
Keeps important logs - Logs when Firebase is misconfigured (actual error)
Removes noise - Stops logging expected "no auth" cases

Why This Solves Problems:

Your logs show "Auth verification failed: missing credentials" constantly
This is EXPECTED for unauthenticated visitors to public pages
Removing this noise makes real errors visible


Verification Plan
After implementing, verify:
1. Server Starts Successfully
bash# Check server starts without errors
npm run dev
# Should see: "Server successfully started on 0.0.0.0:5000"
2. Health Check Works
bashcurl http://localhost:5000/api/health
# Should return: {"status":"ok","timestamp":"..."}
3. Domain Logging Reduced
bash# Make 10 requests, check logs
for i in {1..10}; do curl http://localhost:5000/api/health; done
# Should only see ONE "Domain captured" log, not 10
4. Auth Logging Reduced
bash# Hit a public page without auth, check logs
curl http://localhost:5000/
# Should NOT see "Auth verification failed: missing credentials"
5. Error Handlers Work (Test in Development Only)
typescript// Temporarily add to a test route to verify handlers work:
app.get('/test-crash', (req, res) => {
  throw new Error('Test uncaught exception');
});

app.get('/test-rejection', async (req, res) => {
  Promise.reject(new Error('Test unhandled rejection'));
  res.json({ ok: true });
});
6. Authentication Still Works

Login with Google
Login with email/password
Access protected routes
Logout

7. Background Jobs Still Run
Check logs for:

[CampaignScheduler] Checking for scheduled campaigns
[EmailQueueProcessor] PROCESS-START
[JobProcessor] No pending jobs found


Rollback Plan
If any issues occur, revert by:

Remove the global error handlers from server/index.ts
Restore original domain logging middleware
Restore original auth logging in server/auth.ts

All changes are isolated and easily reversible.

Risk Assessment
ChangeRisk LevelReasonGlobal error handlersLowAdditive only, improves stabilityDomain loggingVery LowOnly changes console.log frequencyAuth loggingVery LowOnly changes console.warn frequency
Overall Risk: LOW - All changes are logging/observability improvements with no business logic modifications.

Expected Outcomes
After implementation:

Cleaner logs - Easier to spot real errors
Crash visibility - Know exactly what caused any crash
Automatic recovery - Server restarts cleanly after errors
No more zombie state - Server won't run in corrupted state after unhandled errors
